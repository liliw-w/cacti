---
title: "CACTI peak-window pipeline"
author: "Lili Wang"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{CACTI peak-window pipeline}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment  = "#>"
)
```

## 1. Introduction

The `cacti` package implements the **CACTI peak-window method** for chromatin QTL mapping.  
It is designed to:

- group nearby peaks into **non-overlapping windows**,  
- residualize peak intensities with respect to covariates,  
- test association between genetic variants and **multi-peak windows** using a
  principal-component omnibus (PCO) test, and  
- optionally aggregate per-chromosome results and compute **window-level FDR**.

The main user-facing functions in this vignette are:

- `cacti_run_chr()` – run the full CACTI peak-window pipeline for **one chromosome**,  
- `cacti_run_genome()` – run the pipeline across **multiple chromosomes** and add FDR.

This vignette explains:

1. The overall workflow.  
2. The expected **input file formats**.  
3. The **output files** produced by the pipeline.  
4. Example usage with bundled toy data under `inst/extdata/`.

---

## 2. Overview of the peak-window pipeline

The CACTI peak-window pipeline has three main steps:

1. **Group peaks into non-overlapping windows**  
   - Using genomic coordinates (chromosome, start, end) of peaks,  
   - Divide the genome into fixed-size windows (e.g. 50 kb),  
   - Assign peaks to these windows and create a **window (group) table**.

2. **Residualize phenotypes with respect to covariates**  
   - Input: peak intensity matrix (features x samples) and covariate matrix (covariates x samples),  
   - Fit linear models `peak ~ covariates`,  
   - Save residualized intensity values in the **same format** as the original matrix, as one of the inputs for the association test.

3. **Run association tests on peak windows**  
   - Input: cis-QTL summary statistics `z` for peak–SNP pairs, peak windows, and residualized phenotype,  
   - For each window:
     - construct a Z-score matrix (variants x peaks),
     - compute a PCO-based multi-peak p-value if the number of peaks ≥ `min_peaks`,
     - otherwise fall back to a univariate p-value,
   - Output: one p-value file per chromosome, one row per `(group, snp)` pair.

Across all chromosomes, `cacti_add_fdr()` (used by `cacti_run_genome()`) aggregates p-values and computes **q-values** for the top hit per window.

---

## 3. Input file formats

This section describes the expected columns and layout of each input file type.

We will also inspect the **toy dataset** bundled with the package in:

```text
inst/extdata/
  test_pheno_meta.bed
  test_pheno.txt
  test_covariates.txt
  test_qtl_sum_stats_chr5.txt.gz
```

### 3.1 Peak metadata (pheno meta / BED-like)

The **peak metadata** file describes the genomic coordinates and IDs of peaks.

- Used by: `cacti_group_peak_window()`, `cacti_run_chr()`, `cacti_run_genome()`
- Argument: `file_pheno_meta`
- Example file: `test_pheno_meta.bed`

Required columns:

- `phe_chr` – chromosome name, typically with `"chr"` prefix (e.g. `"chr5"`),  
- `phe_from` – peak start position (integer; must be `< phe_to`),  
- `phe_to` – peak end position (integer),  
- `phe_id` – unique peak identifier.

```{r show-pheno-meta, message=FALSE}
library(cacti)

file_pheno_meta <- system.file(
  "extdata", "test_pheno_meta.bed",
  package = "cacti"
)

head(data.table::fread(file_pheno_meta))
```

---

### 3.2 Phenotype matrix (peak intensity)

The **phenotype matrix** contains peak intensities (or other quantitative trait values).

- Used by: `cacti_pheno_cov_residual()`, `cacti_run_chr()`, `cacti_run_genome()`
- Argument: `file_pheno`
- Example file: `test_pheno.txt`

Layout:

- Rows = features (peaks).  
- First column = feature ID (matching `phe_id` in metadata).  
- Remaining columns = samples.

```{r show-pheno, message=FALSE}
file_pheno <- system.file(
  "extdata", "test_pheno.txt",
  package = "cacti"
)

head(data.table::fread(file_pheno))[, 1:5]
```

---

### 3.3 Covariate matrix

The **covariate matrix** encodes covariates for each sample (e.g. PCs, batch, sex, etc.).

- Used by: `cacti_pheno_cov_residual()`, `cacti_run_chr()`, `cacti_run_genome()`
- Argument: `file_cov`
- Example file: `test_covariates.txt`

Layout:

- Rows = covariates.  
- First column = covariate ID.  
- Remaining columns = samples.

```{r show-cov, message=FALSE}
file_cov <- system.file(
  "extdata", "test_covariates.txt",
  package = "cacti"
)

head(data.table::fread(file_cov))[, 1:5]
```

---

### 3.4 QTL summary statistics

The **cis-QTL summary stats** file contains association summary statistics for peak–SNP pairs.

- Used by: `cacti_cal_p()`, `cacti_run_chr()`, `cacti_run_genome()`
- Argument: `qtl_file` (per chromosome) or `qtl_files` (multiple chromosomes, given as a vector/template)
- Example file: `test_qtl_sum_stats_chr5.txt.gz`

Required columns:

- `phe_id` – peak ID (matching `phe_id` in metadata and `ID` in phenotype matrix),  
- `var_id` – variant ID,  
- `z` – z-score for the association between that variant and that peak.

```{r show-qtl, message=FALSE}
qtl_file <- system.file(
  "extdata", "test_qtl_sum_stats_chr5.txt.gz",
  package = "cacti"
)

head(data.table::fread(qtl_file))
```

---

## 4. Output files from `cacti_run_chr()`

`cacti_run_chr()` is the main function for running the CACTI peak-window pipeline on a **single chromosome**.

### 4.1 Overview

Calling:

```r
res_single_chr <- cacti_run_chr(
  window_size     = "50kb",
  file_pheno_meta = <peak metadata>,
  file_pheno      = <phenotype matrix>,
  file_cov        = <covariate matrix>,
  chr             = "chr5",
  qtl_file        = <QTL summary stats for chr5>,
  out_prefix      = <output prefix>,
  dir_pco         = "R/pco",
  min_peaks       = 2
)
```

will:

1. Construct peak windows on all chromosomes (using `window_size`).  
2. Residualize the phenotype matrix.  
3. Run the CACTI association test on the specified chromosome (`chr`).  

It returns a named list of output paths, and writes the following files:

### 4.2 Window-level grouping file

- Path: `res_single_chr$file_peak_group`  
- Produced by: `cacti_group_peak_window()`

Columns:

- `group` – window (group) ID (e.g. `"G1"`, `"G2"`, …),  
- `group_chr` – chromosome for the window,  
- `group_from` – window start position,  
- `group_to` – window end position,  
- `pid_group` – semicolon-separated list of peak IDs in the window,  
- `n_pid_group` – number of peaks in the window.

### 4.3 Peak-level grouping file

- Path: `res_single_chr$file_peak_group_peaklevel`

Columns:

- `phe_id` – peak ID,  
- `phe_chr` – chromosome,  
- `phe_from`, `phe_to` – peak start/end,  
- `group` – window ID to which the peak belongs,  
- `n_pid_group` – number of peaks in that window.

### 4.4 Residualized phenotype matrix

- Path: `res_single_chr$file_pheno_cov_residual`  

Same layout as the input phenotype matrix:

- Rows = features (peak IDs),  
- First column = `ID` (peak IDs),  
- Remaining columns = residualized values for each sample.

### 4.5 Per-window p-value file for the chromosome

- Path: `res_single_chr$file_p_peak_group`  

Each row corresponds to a `(group, snp)` pair:

- `group` – window ID,  
- `snp` – variant ID,  
- `pval` – window-level p-value for that variant.  
  - For windows with ≥ `min_peaks` peaks, this is the PCO-based multi-peak p-value.  
  - For single-peak windows, it is a univariate p-value derived from `z`.

---

## 5. Per-chromosome example: `cacti_run_chr()`

Below is an example of running the full pipeline on the **toy chr5 data** included in `inst/extdata/`.

```{r example-run-chr5, eval=TRUE}
library(cacti)

file_pheno_meta <- system.file(
  "extdata", "test_pheno_meta.bed",
  package = "cacti"
)

file_pheno <- system.file(
  "extdata", "test_pheno.txt",
  package = "cacti"
)

file_cov <- system.file(
  "extdata", "test_covariates.txt",
  package = "cacti"
)

qtl_file <- system.file(
  "extdata", "test_qtl_sum_stats_chr5.txt.gz",
  package = "cacti"
)

# Use a temporary prefix to avoid cluttering the working directory
out_prefix <- tempfile("cacti_chr5_")

res_single_chr <- cacti_run_chr(
  window_size     = "50kb",
  file_pheno_meta = file_pheno_meta,
  file_pheno      = file_pheno,
  file_cov        = file_cov,
  chr             = "chr5",
  qtl_file        = qtl_file,
  out_prefix      = out_prefix,
  dir_pco         = "../R/pco",
  min_peaks       = 2
)

res_single_chr
```

---

## 6. Genome-wide wrapper: `cacti_run_genome()`

`cacti_run_genome()` provides a convenience wrapper for running the pipeline across **multiple chromosomes**, then aggregating the p-values and adding FDR via `cacti_add_fdr()`.

Conceptually, it:

1. Loops over `chrs` and calls `cacti_run_chr()` for each one.  
2. Collects all per-chromosome p-value files.  
3. Calls `cacti_add_fdr()` once to compute window-level q-values across all windows and chromosomes.

The simplest usage is when you have one QTL file per chromosome and pass either:

- a character vector `qtl_files` with one path per chromosome, or  
- a template with `"{chr}"` placeholder, e.g. `"extdata/test_qtl_sum_stats_{chr}.txt.gz"`.

In the toy example, we only use data for **chr5**, but this still demonstrates how to call the function.

```{r example-run-genome, eval=TRUE}
file_pheno_meta <- system.file(
  "extdata", "test_pheno_meta.bed",
  package = "cacti"
)

file_pheno <- system.file(
  "extdata", "test_pheno.txt",
  package = "cacti"
)

file_cov <- system.file(
  "extdata", "test_covariates.txt",
  package = "cacti"
)

qtl_file <- system.file(
  "extdata", "test_qtl_sum_stats_chr5.txt.gz",
  package = "cacti"
)

out_prefix <- tempfile("cacti_genome_")

res_genome <- cacti_run_genome(
  window_size     = "50kb",
  file_pheno_meta = file_pheno_meta,
  file_pheno      = file_pheno,
  file_cov        = file_cov,
  chrs            = "chr5",                 # toy example: one chromosome
  qtl_files       = qtl_file,
  out_prefix      = out_prefix,
  dir_pco         = "../R/pco",
  file_fdr_out    = file.path(tempdir(), "cacti_fdr_chr5.txt.gz")
)

res_genome
```

---

## 7. Summary

In this vignette, we:

- described the **CACTI peak-window pipeline**,  
- documented the expected **input file formats** for peak metadata, phenotypes,
  covariates, and QTL summary statistics,
- explained the main **output files** produced by `cacti_run_chr()`, and  
- demonstrated how to run the pipeline per-chromosome and genome-wide using
  bundled toy data in `inst/extdata/`.

For more details on each step, see the function reference:

- `?cacti_group_peak_window`  
- `?cacti_pheno_cov_residual`  
- `?cacti_cal_p`  
- `?cacti_add_fdr`  
- `?cacti_run_chr`  
- `?cacti_run_genome`
